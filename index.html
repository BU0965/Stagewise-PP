<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stagewise Paid Pending Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #back-to-dashboard {
            background-color: #e67e22;
        }

        #back-to-dashboard:hover {
            background-color: #d35400;
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-actions button {
            height: 38px;
        }

        #apply-filter {
            background-color: #2ecc71;
        }

        #apply-filter:hover {
            background-color: #27ae60;
        }

        #clear-filter {
            background-color: #e67e22;
        }

        #clear-filter:hover {
            background-color: #d35400;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .data-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            border: 1px solid #e1e1e1;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
        }

        .sub-header {
            background-color: #2c3e50;
            text-align: center;
            font-weight: bold;
        }

        .total-row {
            background-color: #2c3e50 !important;
            color: white;
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e8f4fd;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .import-export-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #generate-abstract {
            background-color: #2ecc71;
        }

        #generate-abstract:hover {
            background-color: #27ae60;
        }

        #download-abstract {
            background-color: #3498db;
        }

        #download-abstract:hover {
            background-color: #2980b9;
        }

        #generate-list {
            background-color: #9b59b6;
        }

        #generate-list:hover {
            background-color: #8e44ad;
        }

        #file-management {
            background-color: #e74c3c;
        }

        #file-management:hover {
            background-color: #c0392b;
        }

        .progress-container {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #3498db;
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-type-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-type-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stagewise Paid Pending Analysis</h1>
            <div class="controls">
                <button id="back-to-dashboard">Back to Main</button>
            </div>
        </header>

        <div class="filter-section">
            <div class="filter-group">
                <label for="infra-status-filter">Infra Status</label>
                <select id="infra-status-filter">
                    <option value="">All Status</option>
                    <option value="INFRA REQUIRED">Infra Required</option>
                    <option value="INFRA NOT REQUIRED">Infra Not Required</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="category-filter">Category</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <option value="1.RES">1.RES</option>
                    <option value="2.COMM">2.COMM</option>
                    <option value="3.IND">3.IND</option>
                    <option value="4.AG">4.AG</option>
                    <option value="6.PWW">6.PWW</option>
                    <option value="7.PUBLIC-SERVICE">7.PUBLIC-SERVICE</option>
                    <option value="8.OTHER">8.OTHER</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="phase-filter">Phase</label>
                <select id="phase-filter">
                    <option value="">All Phases</option>
                    <option value="SINGLE PHASE">SINGLE PHASE</option>
                    <option value="THREE PHASE">THREE PHASE</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="report-age-filter">Report Age</label>
                <select id="report-age-filter">
                    <option value="">All Report Ages</option>
                    <option value="UPTO 24 HRS">UPTO 24 HRS</option>
                    <option value="1 TO 3 DAYS">1 TO 3 DAYS</option>
                    <option value="4 TO 7 DAYS">4 TO 7 DAYS</option>
                    <option value="8 TO 15 DAYS">8 TO 15 DAYS</option>
                    <option value="16 TO 30 DAYS">16 TO 30 DAYS</option>
                    <option value="2 TO 3 MONTH">2 TO 3 MONTH</option>
                    <option value="4 TO 6 MONTH">4 TO 6 MONTH</option>
                    <option value="7 TO 12 MONTH">7 TO 12 MONTH</option>
                    <option value="ABOVE 12 MONTH">ABOVE 12 MONTH</option>
                </select>
            </div>
            <div class="filter-actions">
                <button id="apply-filter">Apply Filter</button>
                <button id="clear-filter">Clear Filter</button>
            </div>
        </div>

        <div class="status-bar">
            <span id="visible-columns-count">13 columns visible</span>
            <span id="total-rows-count">0 rows</span>
            <span id="import-status">Ready to generate abstract</span>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div class="data-container">
            <table id="data-table">
                <thead>
                    <tr id="table-header">
                        <th rowspan="2">Section</th>
                        <th colspan="2" class="sub-header">A1. Stage</th>
                        <th colspan="3" class="sub-header">Tech Feasibility Stage</th>
                        <th colspan="5" class="sub-header">Estimate Stage</th>
                        <th colspan="2" class="sub-header">Receipt Stage</th>
                        <th rowspan="2" class="sub-header">TOTAL</th>
                    </tr>
                    <tr id="table-sub-header">
                        <!-- A1. Stage sub columns -->
                        <th>Submitted</th>
                        <th>Approved</th>
                        
                        <!-- Tech Feasibility Stage sub columns -->
                        <th>Saved</th>
                        <th>Submitted</th>
                        <th>Approved</th>
                        
                        <!-- Estimate Stage sub columns -->
                        <th>Saved</th>
                        <th>Submitted</th>
                        <th>Verified</th>
                        <th>Rejected</th>
                        <th>Approved</th>
                        
                        <!-- Receipt Stage sub columns -->
                        <th>Submitted</th>
                        <th>Approved</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="import-export-container">
            <div class="import-controls">
                <div class="date-selector">
                    <select id="date-day">
                        <option value="">Day</option>
                        <!-- Days will be populated dynamically -->
                    </select>
                    <select id="date-month">
                        <option value="">Month</option>
                        <!-- Months will be populated dynamically -->
                    </select>
                    <select id="date-year">
                        <option value="">Year</option>
                        <!-- Years will be populated dynamically -->
                    </select>
                </div>
                <div class="file-type-selector">
                    <select id="file-type">
                        <option value="xlsx">XLSX</option>
                        <option value="xls">XLS</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <button id="generate-abstract">Generate Abstract</button>
                <button id="download-abstract">Download Abstract</button>
                <button id="generate-list">Generate List</button>
                <button id="file-management">File Management</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // GitHub Repository URL
        const GITHUB_REPO_URL = "https://bu0965.github.io/Stagewise-PP/";

        // Default sections
        let defaultSections = [];

        // Data storage
        let processedData = null;
        let rawData = []; // Store raw data for filtering
        let filteredData = null; // Store filtered data
        let currentFilters = {
            infraStatus: '',
            category: '',
            phase: '',
            reportAge: ''
        };

        // Store the original Excel data for list generation
        let originalExcelData = null;

        // Excel column mapping for PP_DDMMYYYY.xlsx
        // Note: XLSX uses 0-based indexing
        // Column mappings based on your Excel file
        const excelColumnMapping = {
            "Consumer No": 0,           // Column A
            "Section": 2,               // Column C
            "Category": 5,              // Column F
            "Phase": 15,                // Column P
            "Stage Tag": 8,             // Column I
            "Stage Status": 9,          // Column J
            "Infra Status": 33,         // Column AH (0-based: 33 = column AH in Excel)
            "Report Age": 36            // Column AK (0-based: 36 = column AK in Excel)
        };

        // Initialize date dropdowns
        function initializeDateDropdowns() {
            const daySelect = document.getElementById('date-day');
            const monthSelect = document.getElementById('date-month');
            const yearSelect = document.getElementById('date-year');

            // Populate days (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                daySelect.appendChild(option);
            }

            // Populate months (1-12)
            const months = [
                { value: '01', name: 'January' },
                { value: '02', name: 'February' },
                { value: '03', name: 'March' },
                { value: '04', name: 'April' },
                { value: '05', name: 'May' },
                { value: '06', name: 'June' },
                { value: '07', name: 'July' },
                { value: '08', name: 'August' },
                { value: '09', name: 'September' },
                { value: '10', name: 'October' },
                { value: '11', name: 'November' },
                { value: '12', name: 'December' }
            ];

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });

            // Populate years (2020 to current year + 1)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }

            // Set default to current date
            const today = new Date();
            daySelect.value = today.getDate().toString().padStart(2, '0');
            monthSelect.value = (today.getMonth() + 1).toString().padStart(2, '0');
            yearSelect.value = today.getFullYear().toString();
        }

        // Get selected date
        function getSelectedDate() {
            const day = document.getElementById('date-day').value;
            const month = document.getElementById('date-month').value;
            const year = document.getElementById('date-year').value;

            if (day && month && year) {
                return `PP_${day}${month}${year}`;
            }
            return null;
        }

        // Get selected file type
        function getSelectedFileType() {
            return document.getElementById('file-type').value;
        }

        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Update import status
        function updateImportStatus(message) {
            document.getElementById('import-status').textContent = message;
        }

        // Update progress bar
        function updateProgress(percentage, message = '') {
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');

            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%${message ? ' - ' + message : ''}`;

            if (percentage > 0 && percentage < 100) {
                progressContainer.style.display = 'block';
            } else if (percentage === 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            }
        }

        // Show loading state
        function setLoadingState(loading) {
            const generateButton = document.getElementById('generate-abstract');
            const downloadButton = document.getElementById('download-abstract');
            const generateListButton = document.getElementById('generate-list');
            const fileManagementButton = document.getElementById('file-management');
            const container = document.querySelector('.container');

            if (loading) {
                container.classList.add('loading');
                generateButton.disabled = true;
                generateButton.textContent = 'Generating...';
                downloadButton.disabled = true;
                generateListButton.disabled = true;
                fileManagementButton.disabled = true;
            } else {
                container.classList.remove('loading');
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Abstract';
                downloadButton.disabled = false;
                generateListButton.disabled = false;
                fileManagementButton.disabled = false;
            }
        }

        // Update status bar
        function updateStatusBar(isFiltered = false) {
            const rowCount = rawData.length;
            const filteredRowCount = filteredData ? 
                Object.values(filteredData).reduce((sum, section) => sum + section.total, 0) : 0;
            
            if (isFiltered && filteredData) {
                document.getElementById('total-rows-count').textContent = `${filteredRowCount} filtered rows`;
            } else {
                document.getElementById('total-rows-count').textContent = `${rowCount} rows`;
            }

            const filterStatus = document.getElementById('import-status');
            if (isFiltered && filteredData) {
                filterStatus.textContent = `Filtered: ${filteredRowCount} rows`;
            } else if (rowCount > 0) {
                filterStatus.textContent = `${rowCount} rows loaded`;
            } else {
                filterStatus.textContent = 'Ready to generate abstract';
            }
        }

        // Fetch file from GitHub repository
        async function fetchFileFromGitHub(filePath) {
            try {
                const fileUrl = `${GITHUB_REPO_URL}${filePath}`;
                console.log('Fetching file from:', fileUrl);

                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();

                // Check if file is empty
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('File is empty');
                }

                return arrayBuffer;
            } catch (error) {
                console.error('Error fetching file from GitHub:', error);
                throw error;
            }
        }

        // Function to get cell value safely
        function getCellValue(row, columnIndex) {
            if (!row || row.length <= columnIndex) {
                return '';
            }
            const value = row[columnIndex];
            // Handle different value types
            if (value === null || value === undefined) {
                return '';
            }
            if (typeof value === 'number') {
                return value.toString();
            }
            if (typeof value === 'boolean') {
                return value ? 'TRUE' : 'FALSE';
            }
            return String(value).trim();
        }

        // Clean and normalize values
        function cleanValue(value) {
            if (!value) return '';
            return String(value).trim().toUpperCase();
        }

        // Normalize category value from Excel (Column F)
        function normalizeCategory(category) {
            const cat = cleanValue(category);
            
            // Exact match first
            if (cat === "1.RES") return "1.RES";
            if (cat === "2.COMM") return "2.COMM";
            if (cat === "3.IND") return "3.IND";
            if (cat === "4.AG") return "4.AG";
            if (cat === "6.PWW") return "6.PWW";
            if (cat === "7.PUBLIC-SERVICE") return "7.PUBLIC-SERVICE";
            if (cat === "8.OTHER") return "8.OTHER";
            
            // Check for partial matches
            if (cat.includes("RES")) return "1.RES";
            if (cat.includes("COMM")) return "2.COMM";
            if (cat.includes("IND")) return "3.IND";
            if (cat.includes("AG") && !cat.includes("PWW")) return "4.AG";
            if (cat.includes("PWW")) return "6.PWW";
            if (cat.includes("PUBLIC")) return "7.PUBLIC-SERVICE";
            if (cat.includes("OTHER")) return "8.OTHER";
            
            return cat;
        }

        // Normalize phase value from Excel (Column P)
        function normalizePhase(phase) {
            const ph = cleanValue(phase);
            
            // Exact match first
            if (ph === "SINGLE PHASE") return "SINGLE PHASE";
            if (ph === "THREE PHASE") return "THREE PHASE";
            
            // Check for partial matches
            if (ph.includes("SINGLE")) return "SINGLE PHASE";
            if (ph.includes("THREE") || ph.includes("3 PHASE")) return "THREE PHASE";
            
            return ph;
        }

        // Normalize infra status from Excel (Column AH)
        function normalizeInfraStatus(status) {
            const st = cleanValue(status);
            
            // Exact match first
            if (st === "INFRA REQUIRED") return "INFRA REQUIRED";
            if (st === "INFRA NOT REQUIRED") return "INFRA NOT REQUIRED";
            
            // Check for partial matches
            if (st.includes("REQUIRED") && !st.includes("NOT REQUIRED")) return "INFRA REQUIRED";
            if (st.includes("NOT REQUIRED") || (st.includes("REQUIRED") && st.includes("NOT"))) return "INFRA NOT REQUIRED";
            
            return st;
        }

        // Normalize report age from Excel (Column AK)
        function normalizeReportAge(age) {
            const ag = cleanValue(age);
            
            // Exact match first
            const exactMatches = [
                "UPTO 24 HRS",
                "1 TO 3 DAYS", 
                "4 TO 7 DAYS",
                "8 TO 15 DAYS",
                "16 TO 30 DAYS",
                "2 TO 3 MONTH",
                "4 TO 6 MONTH",
                "7 TO 12 MONTH",
                "ABOVE 12 MONTH"
            ];
            
            for (const match of exactMatches) {
                if (ag === match) return match;
            }
            
            // Check for partial matches
            if (ag.includes("24") || ag.includes("UPTO 24")) return "UPTO 24 HRS";
            if (ag.includes("1 TO 3") || ag.includes("1-3")) return "1 TO 3 DAYS";
            if (ag.includes("4 TO 7") || ag.includes("4-7")) return "4 TO 7 DAYS";
            if (ag.includes("8 TO 15") || ag.includes("8-15")) return "8 TO 15 DAYS";
            if (ag.includes("16 TO 30") || ag.includes("16-30")) return "16 TO 30 DAYS";
            if (ag.includes("2 TO 3 MONTH") || ag.includes("2-3 MONTH")) return "2 TO 3 MONTH";
            if (ag.includes("4 TO 6 MONTH") || ag.includes("4-6 MONTH")) return "4 TO 6 MONTH";
            if (ag.includes("7 TO 12 MONTH") || ag.includes("7-12 MONTH")) return "7 TO 12 MONTH";
            if (ag.includes("ABOVE 12") || ag.includes(">12")) return "ABOVE 12 MONTH";
            
            return ag;
        }

        // Check if row matches all current filters
        function rowMatchesFilters(rowData) {
            // Check infra status filter
            if (currentFilters.infraStatus) {
                if (rowData.normalizedInfraStatus !== currentFilters.infraStatus) {
                    return false;
                }
            }
            
            // Check category filter
            if (currentFilters.category) {
                if (rowData.normalizedCategory !== currentFilters.category) {
                    return false;
                }
            }
            
            // Check phase filter
            if (currentFilters.phase) {
                if (rowData.normalizedPhase !== currentFilters.phase) {
                    return false;
                }
            }
            
            // Check report age filter
            if (currentFilters.reportAge) {
                if (rowData.normalizedReportAge !== currentFilters.reportAge) {
                    return false;
                }
            }
            
            return true;
        }

        // Process data from Excel file
        function processExcelData(jsonData) {
            console.log("=== Processing Excel data ===");
            console.log("Total rows in file:", jsonData.length);
            
            // Store original Excel data for list generation
            originalExcelData = jsonData;
            
            const sectionData = {};
            rawData = []; // Reset raw data
            
            // Reset default sections
            defaultSections = [];

            // First pass: extract all unique sections from column C
            const sectionsSet = new Set();
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;
                
                const section = getCellValue(row, excelColumnMapping["Section"]);
                if (section) {
                    sectionsSet.add(section);
                }
            }
            
            // Convert to array and sort
            defaultSections = Array.from(sectionsSet).sort();
            console.log("Unique sections found:", defaultSections.length, defaultSections);

            // Initialize sections with new structure
            defaultSections.forEach(section => {
                sectionData[section] = {
                    // A1. Stage
                    "A1.Stage": { submitted: 0, approved: 0 },
                    
                    // Tech Feasibility Stage
                    "TechFeasibility": { saved: 0, submitted: 0, approved: 0 },
                    
                    // Estimate Stage
                    "EstimateStage": { saved: 0, submitted: 0, verified: 0, rejected: 0, approved: 0 },
                    
                    // Receipt Stage
                    "ReceiptStage": { submitted: 0, approved: 0 },
                    
                    // Total (single column)
                    "total": 0
                };
            });

            console.log("Section data initialized for", defaultSections.length, "sections");

            // Second pass: process each row
            let rowCount = 0;
            let processedCount = 0;
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                try {
                    rowCount++;
                    
                    // Get all required values from the row using the correct column indices
                    const consumerNo = getCellValue(row, excelColumnMapping["Consumer No"]);
                    const section = getCellValue(row, excelColumnMapping["Section"]);
                    const rawCategory = getCellValue(row, excelColumnMapping["Category"]);
                    const rawPhase = getCellValue(row, excelColumnMapping["Phase"]);
                    const stageTag = getCellValue(row, excelColumnMapping["Stage Tag"]);
                    const stageStatus = getCellValue(row, excelColumnMapping["Stage Status"]);
                    const rawInfraStatus = getCellValue(row, excelColumnMapping["Infra Status"]);
                    const rawReportAge = getCellValue(row, excelColumnMapping["Report Age"]);

                    // Normalize values (convert to uppercase for consistent comparison)
                    const normalizedCategory = normalizeCategory(rawCategory);
                    const normalizedPhase = normalizePhase(rawPhase);
                    const normalizedInfraStatus = normalizeInfraStatus(rawInfraStatus);
                    const normalizedReportAge = normalizeReportAge(rawReportAge);

                    // Skip if no section
                    if (!section) {
                        continue;
                    }

                    // Skip if section not in our list
                    if (!defaultSections.includes(section)) {
                        continue;
                    }

                    processedCount++;

                    // Store raw data for filtering
                    rawData.push({
                        section: section,
                        category: rawCategory,
                        normalizedCategory: normalizedCategory,
                        phase: rawPhase,
                        normalizedPhase: normalizedPhase,
                        infraStatus: rawInfraStatus,
                        normalizedInfraStatus: normalizedInfraStatus,
                        reportAge: rawReportAge,
                        normalizedReportAge: normalizedReportAge,
                        consumerNo: consumerNo,
                        stageTag: stageTag,
                        stageStatus: stageStatus,
                        rowIndex: i,
                        originalRow: row // Store the original row data for list generation
                    });

                    // Get the section object
                    const sectionObj = sectionData[section];
                    
                    // Update counts based on stage tag and status (case-insensitive)
                    const stageTagUpper = stageTag.toUpperCase();
                    const stageStatusUpper = stageStatus.toUpperCase();
                    
                    // A1 Stage
                    if (stageTagUpper.includes("A1") || stageTagUpper.includes("A1.") || stageTagUpper.includes("A1 STAGE")) {
                        if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["A1.Stage"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["A1.Stage"].approved += 1;
                        }
                    } 
                    // Tech Feasibility Stage
                    else if (stageTagUpper.includes("TECH") || stageTagUpper.includes("FEASIBILITY") || stageTagUpper.includes("TECH FEASIBILITY")) {
                        if (stageStatusUpper.includes("SAVED")) {
                            sectionObj["TechFeasibility"].saved += 1;
                        } else if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["TechFeasibility"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["TechFeasibility"].approved += 1;
                        }
                    }
                    // Estimate Stage
                    else if (stageTagUpper.includes("ESTIMATE") || stageTagUpper.includes("ESTIMATE STAGE")) {
                        if (stageStatusUpper.includes("SAVED")) {
                            sectionObj["EstimateStage"].saved += 1;
                        } else if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["EstimateStage"].submitted += 1;
                        } else if (stageStatusUpper.includes("VERIFIED")) {
                            sectionObj["EstimateStage"].verified += 1;
                        } else if (stageStatusUpper.includes("REJECTED")) {
                            sectionObj["EstimateStage"].rejected += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["EstimateStage"].approved += 1;
                        }
                    }
                    // Receipt Stage
                    else if (stageTagUpper.includes("RECEIPT") || stageTagUpper.includes("RECEIPT STAGE")) {
                        if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["ReceiptStage"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["ReceiptStage"].approved += 1;
                        }
                    }

                    // Update total count
                    sectionObj.total += 1;

                } catch (error) {
                    console.warn('Error processing row', i, ':', error);
                    continue;
                }
            }

            console.log("Total rows:", rowCount, "Processed rows:", processedCount);
            
            return sectionData;
        }

        // Apply filters to the table
        function applyFilters() {
            // Get current filter values
            currentFilters.infraStatus = document.getElementById('infra-status-filter').value.toUpperCase();
            currentFilters.category = document.getElementById('category-filter').value;
            currentFilters.phase = document.getElementById('phase-filter').value;
            currentFilters.reportAge = document.getElementById('report-age-filter').value;

            console.log("=== Applying filters ===");
            console.log("Current filters:", currentFilters);

            if (!processedData || rawData.length === 0) {
                showNotification('No data available to filter', true);
                return;
            }

            // Check if any filter is active
            const isAnyFilterActive = currentFilters.infraStatus || 
                                     currentFilters.category || 
                                     currentFilters.phase || 
                                     currentFilters.reportAge;
            
            if (!isAnyFilterActive) {
                // No filters active, show all data
                filteredData = null;
                updateTableWithData(processedData, false);
                showNotification('No filters selected. Showing all data.');
                return;
            }

            // Reset filtered data
            filteredData = {};
            
            // Initialize sections for filtered data
            defaultSections.forEach(section => {
                filteredData[section] = {
                    // A1. Stage
                    "A1.Stage": { submitted: 0, approved: 0 },
                    
                    // Tech Feasibility Stage
                    "TechFeasibility": { saved: 0, submitted: 0, approved: 0 },
                    
                    // Estimate Stage
                    "EstimateStage": { saved: 0, submitted: 0, verified: 0, rejected: 0, approved: 0 },
                    
                    // Receipt Stage
                    "ReceiptStage": { submitted: 0, approved: 0 },
                    
                    // Total (single column)
                    "total": 0
                };
            });

            // Apply filters to raw data and recalculate counts
            let filteredRowCount = 0;
            
            rawData.forEach(row => {
                // Check if row matches all current filters
                if (rowMatchesFilters(row)) {
                    filteredRowCount++;
                    const section = row.section;
                    const sectionObj = filteredData[section];
                    
                    // Update counts based on stage tag and status (case-insensitive)
                    const stageTagUpper = row.stageTag.toUpperCase();
                    const stageStatusUpper = row.stageStatus.toUpperCase();
                    
                    // A1 Stage
                    if (stageTagUpper.includes("A1") || stageTagUpper.includes("A1.") || stageTagUpper.includes("A1 STAGE")) {
                        if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["A1.Stage"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["A1.Stage"].approved += 1;
                        }
                    } 
                    // Tech Feasibility Stage
                    else if (stageTagUpper.includes("TECH") || stageTagUpper.includes("FEASIBILITY") || stageTagUpper.includes("TECH FEASIBILITY")) {
                        if (stageStatusUpper.includes("SAVED")) {
                            sectionObj["TechFeasibility"].saved += 1;
                        } else if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["TechFeasibility"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["TechFeasibility"].approved += 1;
                        }
                    }
                    // Estimate Stage
                    else if (stageTagUpper.includes("ESTIMATE") || stageTagUpper.includes("ESTIMATE STAGE")) {
                        if (stageStatusUpper.includes("SAVED")) {
                            sectionObj["EstimateStage"].saved += 1;
                        } else if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["EstimateStage"].submitted += 1;
                        } else if (stageStatusUpper.includes("VERIFIED")) {
                            sectionObj["EstimateStage"].verified += 1;
                        } else if (stageStatusUpper.includes("REJECTED")) {
                            sectionObj["EstimateStage"].rejected += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["EstimateStage"].approved += 1;
                        }
                    }
                    // Receipt Stage
                    else if (stageTagUpper.includes("RECEIPT") || stageTagUpper.includes("RECEIPT STAGE")) {
                        if (stageStatusUpper.includes("SUBMITTED")) {
                            sectionObj["ReceiptStage"].submitted += 1;
                        } else if (stageStatusUpper.includes("APPROVED")) {
                            sectionObj["ReceiptStage"].approved += 1;
                        }
                    }

                    // Update total
                    sectionObj.total += 1;
                }
            });

            console.log("Filtered rows:", filteredRowCount, "out of", rawData.length);
            
            // Check if any data passed the filters
            let hasFilteredData = false;
            for (const section in filteredData) {
                if (filteredData[section].total > 0) {
                    hasFilteredData = true;
                    break;
                }
            }
            
            if (hasFilteredData) {
                updateTableWithData(filteredData, true);
                showNotification(`Filter applied. Showing ${filteredRowCount} filtered rows.`);
            } else {
                updateTableWithData(filteredData, true);
                showNotification('No data matches the selected filters.', true);
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('infra-status-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('phase-filter').value = '';
            document.getElementById('report-age-filter').value = '';

            // Reset current filters
            currentFilters = {
                infraStatus: '',
                category: '',
                phase: '',
                reportAge: ''
            };

            if (processedData) {
                filteredData = null;
                updateTableWithData(processedData, false);
                showNotification('Filters cleared. Showing all data.');
            }
        }

        // Update table with data
        function updateTableWithData(sectionData, isFiltered = false) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            console.log("Updating table with data (filtered:", isFiltered, ")");

            // Determine which data to show
            const dataToShow = isFiltered ? filteredData : processedData;
            
            if (!dataToShow || Object.keys(dataToShow).length === 0) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = 14;
                emptyCell.textContent = isFiltered ? 'No data matches the selected filters.' : 'No data available. Please generate abstract first.';
                emptyCell.style.textAlign = 'center';
                emptyCell.style.padding = '20px';
                emptyCell.style.color = '#999';
                emptyRow.appendChild(emptyCell);
                tableBody.appendChild(emptyRow);
                updateStatusBar(isFiltered);
                return;
            }

            let grandTotals = {
                a1Submitted: 0,
                a1Approved: 0,
                techSaved: 0,
                techSubmitted: 0,
                techApproved: 0,
                estSaved: 0,
                estSubmitted: 0,
                estVerified: 0,
                estRejected: 0,
                estApproved: 0,
                recSubmitted: 0,
                recApproved: 0,
                total: 0
            };

            let hasData = false;

            // Add sections with data
            defaultSections.forEach(section => {
                if (!dataToShow[section] || dataToShow[section].total === 0) {
                    // Skip sections with no data
                    return;
                }

                hasData = true;
                const row = document.createElement('tr');
                const sectionObj = dataToShow[section];
                
                // Section name
                const sectionCell = document.createElement('td');
                sectionCell.textContent = section;
                row.appendChild(sectionCell);

                // A1. Stage - Submitted
                const a1SubmittedCell = document.createElement('td');
                a1SubmittedCell.textContent = sectionObj["A1.Stage"].submitted;
                row.appendChild(a1SubmittedCell);
                grandTotals.a1Submitted += sectionObj["A1.Stage"].submitted;

                // A1. Stage - Approved
                const a1ApprovedCell = document.createElement('td');
                a1ApprovedCell.textContent = sectionObj["A1.Stage"].approved;
                row.appendChild(a1ApprovedCell);
                grandTotals.a1Approved += sectionObj["A1.Stage"].approved;

                // Tech Feasibility Stage - Saved
                const techSavedCell = document.createElement('td');
                techSavedCell.textContent = sectionObj["TechFeasibility"].saved;
                row.appendChild(techSavedCell);
                grandTotals.techSaved += sectionObj["TechFeasibility"].saved;

                // Tech Feasibility Stage - Submitted
                const techSubmittedCell = document.createElement('td');
                techSubmittedCell.textContent = sectionObj["TechFeasibility"].submitted;
                row.appendChild(techSubmittedCell);
                grandTotals.techSubmitted += sectionObj["TechFeasibility"].submitted;

                // Tech Feasibility Stage - Approved
                const techApprovedCell = document.createElement('td');
                techApprovedCell.textContent = sectionObj["TechFeasibility"].approved;
                row.appendChild(techApprovedCell);
                grandTotals.techApproved += sectionObj["TechFeasibility"].approved;

                // Estimate Stage - Saved
                const estSavedCell = document.createElement('td');
                estSavedCell.textContent = sectionObj["EstimateStage"].saved;
                row.appendChild(estSavedCell);
                grandTotals.estSaved += sectionObj["EstimateStage"].saved;

                // Estimate Stage - Submitted
                const estSubmittedCell = document.createElement('td');
                estSubmittedCell.textContent = sectionObj["EstimateStage"].submitted;
                row.appendChild(estSubmittedCell);
                grandTotals.estSubmitted += sectionObj["EstimateStage"].submitted;

                // Estimate Stage - Verified
                const estVerifiedCell = document.createElement('td');
                estVerifiedCell.textContent = sectionObj["EstimateStage"].verified;
                row.appendChild(estVerifiedCell);
                grandTotals.estVerified += sectionObj["EstimateStage"].verified;

                // Estimate Stage - Rejected
                const estRejectedCell = document.createElement('td');
                estRejectedCell.textContent = sectionObj["EstimateStage"].rejected;
                row.appendChild(estRejectedCell);
                grandTotals.estRejected += sectionObj["EstimateStage"].rejected;

                // Estimate Stage - Approved
                const estApprovedCell = document.createElement('td');
                estApprovedCell.textContent = sectionObj["EstimateStage"].approved;
                row.appendChild(estApprovedCell);
                grandTotals.estApproved += sectionObj["EstimateStage"].approved;

                // Receipt Stage - Submitted
                const recSubmittedCell = document.createElement('td');
                recSubmittedCell.textContent = sectionObj["ReceiptStage"].submitted;
                row.appendChild(recSubmittedCell);
                grandTotals.recSubmitted += sectionObj["ReceiptStage"].submitted;

                // Receipt Stage - Approved
                const recApprovedCell = document.createElement('td');
                recApprovedCell.textContent = sectionObj["ReceiptStage"].approved;
                row.appendChild(recApprovedCell);
                grandTotals.recApproved += sectionObj["ReceiptStage"].approved;

                // TOTAL - Sum of all counts
                const totalValue = sectionObj["A1.Stage"].submitted + sectionObj["A1.Stage"].approved +
                                 sectionObj["TechFeasibility"].saved + sectionObj["TechFeasibility"].submitted + sectionObj["TechFeasibility"].approved +
                                 sectionObj["EstimateStage"].saved + sectionObj["EstimateStage"].submitted + sectionObj["EstimateStage"].verified + 
                                 sectionObj["EstimateStage"].rejected + sectionObj["EstimateStage"].approved +
                                 sectionObj["ReceiptStage"].submitted + sectionObj["ReceiptStage"].approved;
                
                const totalCell = document.createElement('td');
                totalCell.textContent = totalValue;
                row.appendChild(totalCell);
                grandTotals.total += totalValue;

                tableBody.appendChild(row);
            });

            // If no data in any section, show message
            if (!hasData) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = 14;
                emptyCell.textContent = isFiltered ? 'No data matches the selected filters.' : 'No data available in the selected sections.';
                emptyCell.style.textAlign = 'center';
                emptyCell.style.padding = '20px';
                emptyCell.style.color = '#999';
                emptyRow.appendChild(emptyCell);
                tableBody.appendChild(emptyRow);
                updateStatusBar(isFiltered);
                return;
            }

            // Add TOTAL row only if we have data
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'TOTAL';
            totalRow.appendChild(totalLabelCell);

            // A1. Stage - Submitted total
            const a1SubmittedTotal = document.createElement('td');
            a1SubmittedTotal.textContent = grandTotals.a1Submitted;
            totalRow.appendChild(a1SubmittedTotal);

            // A1. Stage - Approved total
            const a1ApprovedTotal = document.createElement('td');
            a1ApprovedTotal.textContent = grandTotals.a1Approved;
            totalRow.appendChild(a1ApprovedTotal);

            // Tech Feasibility Stage - Saved total
            const techSavedTotal = document.createElement('td');
            techSavedTotal.textContent = grandTotals.techSaved;
            totalRow.appendChild(techSavedTotal);

            // Tech Feasibility Stage - Submitted total
            const techSubmittedTotal = document.createElement('td');
            techSubmittedTotal.textContent = grandTotals.techSubmitted;
            totalRow.appendChild(techSubmittedTotal);

            // Tech Feasibility Stage - Approved total
            const techApprovedTotal = document.createElement('td');
            techApprovedTotal.textContent = grandTotals.techApproved;
            totalRow.appendChild(techApprovedTotal);

            // Estimate Stage - Saved total
            const estSavedTotal = document.createElement('td');
            estSavedTotal.textContent = grandTotals.estSaved;
            totalRow.appendChild(estSavedTotal);

            // Estimate Stage - Submitted total
            const estSubmittedTotal = document.createElement('td');
            estSubmittedTotal.textContent = grandTotals.estSubmitted;
            totalRow.appendChild(estSubmittedTotal);

            // Estimate Stage - Verified total
            const estVerifiedTotal = document.createElement('td');
            estVerifiedTotal.textContent = grandTotals.estVerified;
            totalRow.appendChild(estVerifiedTotal);

            // Estimate Stage - Rejected total
            const estRejectedTotal = document.createElement('td');
            estRejectedTotal.textContent = grandTotals.estRejected;
            totalRow.appendChild(estRejectedTotal);

            // Estimate Stage - Approved total
            const estApprovedTotal = document.createElement('td');
            estApprovedTotal.textContent = grandTotals.estApproved;
            totalRow.appendChild(estApprovedTotal);

            // Receipt Stage - Submitted total
            const recSubmittedTotal = document.createElement('td');
            recSubmittedTotal.textContent = grandTotals.recSubmitted;
            totalRow.appendChild(recSubmittedTotal);

            // Receipt Stage - Approved total
            const recApprovedTotal = document.createElement('td');
            recApprovedTotal.textContent = grandTotals.recApproved;
            totalRow.appendChild(recApprovedTotal);

            // TOTAL - Sum of all values
            const totalTotal = document.createElement('td');
            totalTotal.textContent = grandTotals.total;
            totalRow.appendChild(totalTotal);

            tableBody.appendChild(totalRow);
            updateStatusBar(isFiltered);
        }

        // Download abstract as Excel file
        function downloadAbstract() {
            const dataToDownload = filteredData || processedData;
            
            if (!dataToDownload) {
                showNotification('No data available to download', true);
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for the table
                const tableData = [];
                
                // Add headers
                tableData.push([
                    'Section',
                    'A1. Stage Submitted', 'A1. Stage Approved',
                    'Tech Feasibility Saved', 'Tech Feasibility Submitted', 'Tech Feasibility Approved',
                    'Estimate Saved', 'Estimate Submitted', 'Estimate Verified', 'Estimate Rejected', 'Estimate Approved',
                    'Receipt Submitted', 'Receipt Approved',
                    'Total'
                ]);

                // Add data for each section
                defaultSections.forEach(section => {
                    if (!dataToDownload[section] || dataToDownload[section].total === 0) return;
                    
                    const sectionObj = dataToDownload[section];
                    const totalValue = sectionObj["A1.Stage"].submitted + sectionObj["A1.Stage"].approved +
                                     sectionObj["TechFeasibility"].saved + sectionObj["TechFeasibility"].submitted + sectionObj["TechFeasibility"].approved +
                                     sectionObj["EstimateStage"].saved + sectionObj["EstimateStage"].submitted + sectionObj["EstimateStage"].verified + 
                                     sectionObj["EstimateStage"].rejected + sectionObj["EstimateStage"].approved +
                                     sectionObj["ReceiptStage"].submitted + sectionObj["ReceiptStage"].approved;
                    
                    const row = [
                        section,
                        sectionObj["A1.Stage"].submitted,
                        sectionObj["A1.Stage"].approved,
                        sectionObj["TechFeasibility"].saved,
                        sectionObj["TechFeasibility"].submitted,
                        sectionObj["TechFeasibility"].approved,
                        sectionObj["EstimateStage"].saved,
                        sectionObj["EstimateStage"].submitted,
                        sectionObj["EstimateStage"].verified,
                        sectionObj["EstimateStage"].rejected,
                        sectionObj["EstimateStage"].approved,
                        sectionObj["ReceiptStage"].submitted,
                        sectionObj["ReceiptStage"].approved,
                        totalValue
                    ];
                    tableData.push(row);
                });

                // Calculate totals
                const totals = {
                    a1Submitted: 0,
                    a1Approved: 0,
                    techSaved: 0,
                    techSubmitted: 0,
                    techApproved: 0,
                    estSaved: 0,
                    estSubmitted: 0,
                    estVerified: 0,
                    estRejected: 0,
                    estApproved: 0,
                    recSubmitted: 0,
                    recApproved: 0,
                    total: 0
                };

                defaultSections.forEach(section => {
                    if (!dataToDownload[section] || dataToDownload[section].total === 0) return;
                    const sectionObj = dataToDownload[section];
                    totals.a1Submitted += sectionObj["A1.Stage"].submitted;
                    totals.a1Approved += sectionObj["A1.Stage"].approved;
                    totals.techSaved += sectionObj["TechFeasibility"].saved;
                    totals.techSubmitted += sectionObj["TechFeasibility"].submitted;
                    totals.techApproved += sectionObj["TechFeasibility"].approved;
                    totals.estSaved += sectionObj["EstimateStage"].saved;
                    totals.estSubmitted += sectionObj["EstimateStage"].submitted;
                    totals.estVerified += sectionObj["EstimateStage"].verified;
                    totals.estRejected += sectionObj["EstimateStage"].rejected;
                    totals.estApproved += sectionObj["EstimateStage"].approved;
                    totals.recSubmitted += sectionObj["ReceiptStage"].submitted;
                    totals.recApproved += sectionObj["ReceiptStage"].approved;
                    totals.total += (sectionObj["A1.Stage"].submitted + sectionObj["A1.Stage"].approved +
                                   sectionObj["TechFeasibility"].saved + sectionObj["TechFeasibility"].submitted + sectionObj["TechFeasibility"].approved +
                                   sectionObj["EstimateStage"].saved + sectionObj["EstimateStage"].submitted + sectionObj["EstimateStage"].verified + 
                                   sectionObj["EstimateStage"].rejected + sectionObj["EstimateStage"].approved +
                                   sectionObj["ReceiptStage"].submitted + sectionObj["ReceiptStage"].approved);
                });

                // Add TOTAL row
                tableData.push([
                    'TOTAL',
                    totals.a1Submitted,
                    totals.a1Approved,
                    totals.techSaved,
                    totals.techSubmitted,
                    totals.techApproved,
                    totals.estSaved,
                    totals.estSubmitted,
                    totals.estVerified,
                    totals.estRejected,
                    totals.estApproved,
                    totals.recSubmitted,
                    totals.recApproved,
                    totals.total
                ]);

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(tableData);
                XLSX.utils.book_append_sheet(wb, ws, 'Stagewise Analysis');

                // Generate Excel file and trigger download
                const fileName = `stagewise_paid_pending_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Abstract downloaded successfully!');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading abstract: ' + error.message, true);
            }
        }

        // Generate list - FIXED VERSION
        function generateList() {
            if (!processedData || rawData.length === 0) {
                showNotification('No data available to generate list', true);
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare detailed list data
                const listData = [];
                
                // Add headers for detailed list - using all columns from original Excel
                const headers = originalExcelData[0] || [];
                listData.push(headers);

                // Determine which rows to include based on current filters
                const rowsToInclude = [];
                
                if (filteredData) {
                    // If filters are active, only include rows that match the filters
                    rawData.forEach(row => {
                        if (rowMatchesFilters(row)) {
                            rowsToInclude.push(row.rowIndex);
                        }
                    });
                } else {
                    // If no filters active, include all rows
                    for (let i = 1; i < originalExcelData.length; i++) {
                        rowsToInclude.push(i);
                    }
                }

                console.log("Generating list with", rowsToInclude.length, "rows");

                // Add the filtered rows
                rowsToInclude.forEach(rowIndex => {
                    if (rowIndex < originalExcelData.length) {
                        listData.push(originalExcelData[rowIndex]);
                    }
                });

                // Create worksheet for detailed list
                const ws = XLSX.utils.aoa_to_sheet(listData);
                XLSX.utils.book_append_sheet(wb, ws, 'Detailed List');

                // Generate Excel file and trigger download
                const fileName = `detailed_list_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification(`List generated with ${rowsToInclude.length} rows!`);
            } catch (error) {
                console.error('List generation error:', error);
                showNotification('Error generating list: ' + error.message, true);
            }
        }

        // Generate abstract from data
        async function generateAbstract() {
            try {
                // Get selected date and file type
                const datePart = getSelectedDate();
                const fileType = getSelectedFileType();

                if (!datePart) {
                    showNotification('Please select a valid date', true);
                    return;
                }

                const fileName = `${datePart}.${fileType}`;
                console.log("Looking for file:", fileName);

                setLoadingState(true);
                updateProgress(0, 'Fetching data file from GitHub...');

                updateProgress(30, 'Fetching main data file...');

                // Try different file formats
                const possibleFileNames = [
                    fileName,
                    fileName.toUpperCase(),
                    fileName.replace(/.xlsx$/i, '.xls'),
                    fileName.replace(/.xls$/i, '.xlsx'),
                    fileName.replace(/.csv$/i, '.xlsx')
                ];

                console.log("Trying file names:", possibleFileNames);

                let data = null;
                let usedFileName = '';

                for (const name of possibleFileNames) {
                    try {
                        data = await fetchFileFromGitHub(name);
                        usedFileName = name;
                        console.log(`Successfully loaded ${name}`);
                        break;
                    } catch (error) {
                        console.warn(`Failed to load ${name}:`, error.message);
                        continue;
                    }
                }

                if (!data) {
                    throw new Error(`Could not find data file. Tried: ${possibleFileNames.join(', ')}`);
                }

                updateProgress(60, 'Processing data...');

                let jsonData;
                if (fileType === 'csv') {
                    const csvString = new TextDecoder().decode(data);
                    jsonData = XLSX.utils.sheet_to_json(
                        XLSX.utils.aoa_to_sheet(
                            csvString.split('\n').map(row => row.split(','))
                        ),
                        { header: 1 }
                    );
                } else {
                    const workbook = XLSX.read(data, { type: 'array' });
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Excel file contains no sheets');
                    }
                    
                    console.log("Sheet names:", workbook.SheetNames);
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                }

                console.log("Raw JSON data length:", jsonData.length);
                
                if (jsonData.length <= 1) {
                    showNotification('No data found in the file', true);
                    updateImportStatus('No data found');
                    setLoadingState(false);
                    return;
                }

                updateProgress(80, 'Generating abstract...');

                // Process the data
                processedData = processExcelData(jsonData);
                filteredData = null; // Reset filtered data when loading new data
                
                // Reset current filters
                currentFilters = {
                    infraStatus: '',
                    category: '',
                    phase: '',
                    reportAge: ''
                };

                // Clear filter dropdowns
                document.getElementById('infra-status-filter').value = '';
                document.getElementById('category-filter').value = '';
                document.getElementById('phase-filter').value = '';
                document.getElementById('report-age-filter').value = '';

                setLoadingState(false);
                updateProgress(100, 'Abstract generated successfully');

                // Update table with processed data
                updateTableWithData(processedData, false);

                showNotification(`Successfully generated abstract from ${usedFileName}!`);
                updateImportStatus(`Abstract generated from ${usedFileName}`);

                updateStatusBar(false);

            } catch (error) {
                console.error('Error generating abstract:', error);
                showNotification('Error generating abstract: ' + error.message, true);
                updateImportStatus('Generation failed');
                setLoadingState(false);
            }
        }

        // Event listeners
        document.getElementById('generate-abstract').addEventListener('click', generateAbstract);
        document.getElementById('download-abstract').addEventListener('click', downloadAbstract);
        document.getElementById('generate-list').addEventListener('click', generateList);
        
        // File Management button
        document.getElementById('file-management').addEventListener('click', () => {
            window.location.href = 'file-management.html';
        });

        document.getElementById('apply-filter').addEventListener('click', applyFilters);
        document.getElementById('clear-filter').addEventListener('click', clearFilters);

        // Back to Main button
        document.getElementById('back-to-dashboard').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateDropdowns();

            // Debug help
            console.log('Stagewise Paid Pending Analysis initialized');
            console.log('GitHub Repo URL:', GITHUB_REPO_URL);
            console.log('Excel column mapping:', excelColumnMapping);
        });
    </script>
</body>
</html>