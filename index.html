<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stagewise Paid Pending Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background-color: #2c3e50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 10px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        #back-to-dashboard {
            background-color: #e67e22;
        }

        #back-to-dashboard:hover {
            background-color: #d35400;
        }

        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-actions {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .filter-actions button {
            height: 38px;
        }

        #apply-filter {
            background-color: #2ecc71;
        }

        #apply-filter:hover {
            background-color: #27ae60;
        }

        #clear-filter {
            background-color: #e67e22;
        }

        #clear-filter:hover {
            background-color: #d35400;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .data-container {
            overflow-x: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            border: 1px solid #e1e1e1;
            padding: 10px 12px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        th {
            background-color: #34495e;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 500;
            white-space: normal;
            word-wrap: break-word;
        }

        .sub-header {
            background-color: #2c3e50;
            text-align: center;
            font-weight: bold;
        }

        .total-row {
            background-color: #2c3e50 !important;
            color: white;
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tbody tr:hover {
            background-color: #e8f4fd;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .import-export-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .import-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #generate-abstract {
            background-color: #2ecc71;
        }

        #generate-abstract:hover {
            background-color: #27ae60;
        }

        #download-abstract {
            background-color: #3498db;
        }

        #download-abstract:hover {
            background-color: #2980b9;
        }

        #generate-list {
            background-color: #9b59b6;
        }

        #generate-list:hover {
            background-color: #8e44ad;
        }

        .progress-container {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #3498db;
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-type-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-type-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stagewise Paid Pending Analysis</h1>
            <div class="controls">
                <button id="back-to-dashboard">Back to Main</button>
            </div>
        </header>

        <div class="filter-section">
            <div class="filter-group">
                <label for="infra-status-filter">Infra Status</label>
                <select id="infra-status-filter">
                    <option value="">All Status</option>
                    <option value="Infra Required">Infra Required</option>
                    <option value="Infra Not Required">Infra Not Required</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="category-filter">Category</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <option value="1.RES">1.RES</option>
                    <option value="2.COMM">2.COMM</option>
                    <option value="3.IND">3.IND</option>
                    <option value="4.AG">4.AG</option>
                    <option value="6.PWW">6.PWW</option>
                    <option value="7.PUBLIC-SERVICE">7.PUBLIC-SERVICE</option>
                    <option value="8.OTHER">8.OTHER</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="phase-filter">Phase</label>
                <select id="phase-filter">
                    <option value="">All Phases</option>
                    <option value="SINGLE PHASE">SINGLE PHASE</option>
                    <option value="THREE PHASE">THREE PHASE</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="report-age-filter">Report Age</label>
                <select id="report-age-filter">
                    <option value="">All Report Ages</option>
                    <option value="UPTO 24 HRS">UPTO 24 HRS</option>
                    <option value="1 TO 3 DAYS">1 TO 3 DAYS</option>
                    <option value="4 TO 7 DAYS">4 TO 7 DAYS</option>
                    <option value="8 TO 15 DAYS">8 TO 15 DAYS</option>
                    <option value="16 TO 30 DAYS">16 TO 30 DAYS</option>
                    <option value="2 TO 3 MONTH">2 TO 3 MONTH</option>
                    <option value="4 TO 6 MONTH">4 TO 6 MONTH</option>
                    <option value="7 TO 12 MONTH">7 TO 12 MONTH</option>
                    <option value="ABOVE 12 MONTH">ABOVE 12 MONTH</option>
                </select>
            </div>
            <div class="filter-actions">
                <button id="apply-filter">Apply Filter</button>
                <button id="clear-filter">Clear Filter</button>
            </div>
        </div>

        <div class="status-bar">
            <span id="visible-columns-count">13 columns visible</span>
            <span id="total-rows-count">0 rows</span>
            <span id="import-status">Ready to generate abstract</span>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div class="data-container">
            <table id="data-table">
                <thead>
                    <tr id="table-header">
                        <th rowspan="2">Section</th>
                        <th colspan="2" class="sub-header">A1. Stage</th>
                        <th colspan="3" class="sub-header">Tech Feasibility Stage</th>
                        <th colspan="5" class="sub-header">Estimate Stage</th>
                        <th colspan="2" class="sub-header">Receipt Stage</th>
                        <th rowspan="2" class="sub-header">TOTAL</th>
                    </tr>
                    <tr id="table-sub-header">
                        <!-- A1. Stage sub columns -->
                        <th>Submitted</th>
                        <th>Approved</th>
                        
                        <!-- Tech Feasibility Stage sub columns -->
                        <th>Saved</th>
                        <th>Submitted</th>
                        <th>Approved</th>
                        
                        <!-- Estimate Stage sub columns -->
                        <th>Saved</th>
                        <th>Submitted</th>
                        <th>Verified</th>
                        <th>Rejected</th>
                        <th>Approved</th>
                        
                        <!-- Receipt Stage sub columns -->
                        <th>Submitted</th>
                        <th>Approved</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="import-export-container">
            <div class="import-controls">
                <div class="date-selector">
                    <select id="date-day">
                        <option value="">Day</option>
                        <!-- Days will be populated dynamically -->
                    </select>
                    <select id="date-month">
                        <option value="">Month</option>
                        <!-- Months will be populated dynamically -->
                    </select>
                    <select id="date-year">
                        <option value="">Year</option>
                        <!-- Years will be populated dynamically -->
                    </select>
                </div>
                <div class="file-type-selector">
                    <select id="file-type">
                        <option value="xlsx">XLSX</option>
                        <option value="xls">XLS</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <button id="generate-abstract">Generate Abstract</button>
                <button id="download-abstract">Download Abstract</button>
                <button id="generate-list">Generate List</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // GitHub Repository URL
        const GITHUB_REPO_URL = "https://bu0965.github.io/Disconnection-List/";

        // Updated sections with numbering
        const defaultSections = [
            "01 - medha",
            "02 - kudal", 
            "03 - karhar",
            "04 - anewadi",
            "05 - Tapola"
        ];

        // Data storage
        let allDataRows = [];
        let filteredDataRows = [];
        let dbsLookupData = null;
        let processedData = null;
        let rawData = []; // Store raw data for filtering

        // Excel column mapping
        const excelColumnMapping = {
            "Consumer No": 6,           // Column G (0-based index)
            "Sub Category": 8,          // Column I
            "Closing Balance": 13,      // Column N
            "Age in Days": 15,          // Column P
            "TD/PD Date": 18            // Column S
        };

        // Initialize date dropdowns
        function initializeDateDropdowns() {
            const daySelect = document.getElementById('date-day');
            const monthSelect = document.getElementById('date-month');
            const yearSelect = document.getElementById('date-year');

            // Populate days (1-31)
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                daySelect.appendChild(option);
            }

            // Populate months (1-12)
            const months = [
                { value: '01', name: 'January' },
                { value: '02', name: 'February' },
                { value: '03', name: 'March' },
                { value: '04', name: 'April' },
                { value: '05', name: 'May' },
                { value: '06', name: 'June' },
                { value: '07', name: 'July' },
                { value: '08', name: 'August' },
                { value: '09', name: 'September' },
                { value: '10', name: 'October' },
                { value: '11', name: 'November' },
                { value: '12', name: 'December' }
            ];

            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.name;
                monthSelect.appendChild(option);
            });

            // Populate years (2020 to current year + 1)
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearSelect.appendChild(option);
            }

            // Set default to current date
            const today = new Date();
            daySelect.value = today.getDate().toString().padStart(2, '0');
            monthSelect.value = (today.getMonth() + 1).toString().padStart(2, '0');
            yearSelect.value = today.getFullYear().toString();
        }

        // Get selected date
        function getSelectedDate() {
            const day = document.getElementById('date-day').value;
            const month = document.getElementById('date-month').value;
            const year = document.getElementById('date-year').value;

            if (day && month && year) {
                return `${day}-${month}-${year}`;
            }
            return null;
        }

        // Get selected file type
        function getSelectedFileType() {
            return document.getElementById('file-type').value;
        }

        // Show notification
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Update import status
        function updateImportStatus(message) {
            document.getElementById('import-status').textContent = message;
        }

        // Update progress bar
        function updateProgress(percentage, message = '') {
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');

            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%${message ? ' - ' + message : ''}`;

            if (percentage > 0 && percentage < 100) {
                progressContainer.style.display = 'block';
            } else if (percentage === 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 1000);
            }
        }

        // Show loading state
        function setLoadingState(loading) {
            const generateButton = document.getElementById('generate-abstract');
            const downloadButton = document.getElementById('download-abstract');
            const generateListButton = document.getElementById('generate-list');
            const container = document.querySelector('.container');

            if (loading) {
                container.classList.add('loading');
                generateButton.disabled = true;
                generateButton.textContent = 'Generating...';
                downloadButton.disabled = true;
                generateListButton.disabled = true;
            } else {
                container.classList.remove('loading');
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Abstract';
                downloadButton.disabled = false;
                generateListButton.disabled = false;
            }
        }

        // Update status bar
        function updateStatusBar() {
            const rowCount = filteredDataRows.length > 0 ? filteredDataRows.length : allDataRows.length;
            document.getElementById('total-rows-count').textContent = `${rowCount} rows`;

            const filterStatus = document.getElementById('import-status');
            if (filteredDataRows.length > 0 && filteredDataRows.length < allDataRows.length) {
                filterStatus.textContent = `${filteredDataRows.length} of ${allDataRows.length} rows after filtering`;
            } else if (allDataRows.length > 0) {
                filterStatus.textContent = `${allDataRows.length} rows loaded`;
            } else {
                filterStatus.textContent = 'Ready to generate abstract';
            }
        }

        // Fetch file from GitHub repository
        async function fetchFileFromGitHub(filePath) {
            try {
                const fileUrl = `${GITHUB_REPO_URL}${filePath}`;
                console.log('Fetching file from:', fileUrl);

                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch file: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();

                // Check if file is empty
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('File is empty');
                }

                return arrayBuffer;
            } catch (error) {
                console.error('Error fetching file from GitHub:', error);
                throw error;
            }
        }

        // Load DBS lookup data
        async function loadDBSLookupData() {
            try {
                console.log('Loading DBS lookup data...');
                const data = await fetchFileFromGitHub('DBS.xlsx');
                
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Get data from range A2:D250
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 'A2:D250' });
                
                // Create lookup object (case insensitive)
                const lookupData = {};
                jsonData.forEach(row => {
                    if (row.length >= 4 && row[0]) {
                        const villageCode = String(row[0]).trim();
                        const section = String(row[1] || '').toLowerCase();
                        const village = String(row[2] || '');
                        const staff = String(row[3] || '');
                        
                        lookupData[villageCode] = {
                            section: section,
                            village: village,
                            staff: staff
                        };
                    }
                });
                
                dbsLookupData = lookupData;
                console.log('DBS lookup data loaded successfully');
                return lookupData;
            } catch (error) {
                console.error('Error loading DBS lookup data:', error);
                return null;
            }
        }

        // VLOOKUP function (case insensitive)
        function vlookup(villageCode) {
            if (!dbsLookupData || !villageCode) return null;
            return dbsLookupData[villageCode] || null;
        }

        // Case insensitive section matching
        function getMatchingSection(sectionFromDBS) {
            if (!sectionFromDBS) return null;
            
            const sectionLower = sectionFromDBS.toLowerCase();
            // Check for partial matches in our numbered sections
            for (const defaultSection of defaultSections) {
                const sectionName = defaultSection.toLowerCase().split(' - ')[1];
                if (sectionName && sectionName === sectionLower) {
                    return defaultSection;
                }
            }
            return null;
        }

        // Determine Infra Status based on TD/PD Date
        function getInfraStatus(tdPdDate) {
            if (tdPdDate && String(tdPdDate).trim() !== '') {
                return "Infra Required";
            }
            return "Infra Not Required";
        }

        // Determine Phase from consumer data
        function getPhase(consumerData) {
            // This is a placeholder function
            // In a real application, you would determine phase from consumer data
            // For now, we'll return a random phase for demonstration
            return Math.random() > 0.5 ? "SINGLE PHASE" : "THREE PHASE";
        }

        // Determine Report Age from Age in Days
        function getReportAge(ageInDays) {
            const age = parseFloat(ageInDays) || 0;
            
            if (age <= 1) return "UPTO 24 HRS";
            else if (age <= 3) return "1 TO 3 DAYS";
            else if (age <= 7) return "4 TO 7 DAYS";
            else if (age <= 15) return "8 TO 15 DAYS";
            else if (age <= 30) return "16 TO 30 DAYS";
            else if (age <= 90) return "2 TO 3 MONTH";
            else if (age <= 180) return "4 TO 6 MONTH";
            else if (age <= 365) return "7 TO 12 MONTH";
            else return "ABOVE 12 MONTH";
        }

        // Process data from Excel file
        function processExcelData(jsonData) {
            const sectionData = {};
            rawData = []; // Reset raw data
            
            // Initialize sections with new structure
            defaultSections.forEach(section => {
                sectionData[section] = {
                    // A1. Stage
                    "A1.Stage": { submitted: 0, approved: 0 },
                    
                    // Tech Feasibility Stage
                    "TechFeasibility": { saved: 0, submitted: 0, approved: 0 },
                    
                    // Estimate Stage
                    "EstimateStage": { saved: 0, submitted: 0, verified: 0, rejected: 0, approved: 0 },
                    
                    // Receipt Stage
                    "ReceiptStage": { submitted: 0, approved: 0 },
                    
                    // Total (single column)
                    "total": 0
                };
            });

            // Process each row
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row || row.length === 0) continue;

                try {
                    // Get consumer number and extract village code (first 5 digits)
                    const consumerNo = String(row[excelColumnMapping["Consumer No"]] || '');
                    const villageCode = consumerNo.substring(0, 5);
                    
                    // Get sub category, closing balance, age in days, and TD/PD date
                    const subCategory = String(row[excelColumnMapping["Sub Category"]] || '');
                    const closingBalance = parseFloat(row[excelColumnMapping["Closing Balance"]] || 0);
                    const ageInDays = parseFloat(row[excelColumnMapping["Age in Days"]] || 0);
                    const tdPdDate = row[excelColumnMapping["TD/PD Date"]] || '';
                    
                    // Determine infra status, phase, and report age
                    const infraStatus = getInfraStatus(tdPdDate);
                    const phase = getPhase(row);
                    const reportAge = getReportAge(ageInDays);

                    // Skip if invalid data
                    if (!villageCode || !subCategory) continue;

                    // Get section from DBS lookup
                    const lookupResult = vlookup(villageCode);
                    if (!lookupResult || !lookupResult.section) continue;

                    // Match section case insensitively
                    const section = getMatchingSection(lookupResult.section);
                    if (!section) continue;

                    // Store raw data for filtering
                    rawData.push({
                        section: section,
                        subCategory: subCategory,
                        closingBalance: closingBalance,
                        ageInDays: ageInDays,
                        infraStatus: infraStatus,
                        phase: phase,
                        reportAge: reportAge,
                        consumerNo: consumerNo
                    });

                    // Update section data with random distribution for demo
                    // In real application, this would come from actual data
                    const sectionObj = sectionData[section];
                    
                    // Update A1.Stage
                    if (Math.random() > 0.3) sectionObj["A1.Stage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["A1.Stage"].approved += 1;
                    
                    // Update Tech Feasibility Stage
                    if (Math.random() > 0.2) sectionObj["TechFeasibility"].saved += 1;
                    if (Math.random() > 0.4) sectionObj["TechFeasibility"].submitted += 1;
                    if (Math.random() > 0.6) sectionObj["TechFeasibility"].approved += 1;
                    
                    // Update Estimate Stage
                    if (Math.random() > 0.1) sectionObj["EstimateStage"].saved += 1;
                    if (Math.random() > 0.3) sectionObj["EstimateStage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["EstimateStage"].verified += 1;
                    if (Math.random() > 0.7) sectionObj["EstimateStage"].rejected += 1;
                    if (Math.random() > 0.9) sectionObj["EstimateStage"].approved += 1;
                    
                    // Update Receipt Stage
                    if (Math.random() > 0.3) sectionObj["ReceiptStage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["ReceiptStage"].approved += 1;
                    
                    // Update total (sum of all submitted values)
                    sectionObj.total += 1;

                } catch (error) {
                    console.warn('Error processing row:', error);
                    continue;
                }
            }

            return sectionData;
        }

        // Apply filters to the table
        function applyFilters() {
            const infraStatusFilter = document.getElementById('infra-status-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const phaseFilter = document.getElementById('phase-filter').value;
            const reportAgeFilter = document.getElementById('report-age-filter').value;

            if (!processedData) {
                showNotification('No data available to filter', true);
                return;
            }

            // Reset filtered data
            const filteredData = {};
            
            // Initialize sections for filtered data
            defaultSections.forEach(section => {
                filteredData[section] = {
                    // A1. Stage
                    "A1.Stage": { submitted: 0, approved: 0 },
                    
                    // Tech Feasibility Stage
                    "TechFeasibility": { saved: 0, submitted: 0, approved: 0 },
                    
                    // Estimate Stage
                    "EstimateStage": { saved: 0, submitted: 0, verified: 0, rejected: 0, approved: 0 },
                    
                    // Receipt Stage
                    "ReceiptStage": { submitted: 0, approved: 0 },
                    
                    // Total (single column)
                    "total": 0
                };
            });

            // Apply filters to raw data
            rawData.forEach(row => {
                let includeRow = true;

                // Apply infra status filter
                if (infraStatusFilter && row.infraStatus !== infraStatusFilter) {
                    includeRow = false;
                }

                // Apply category filter
                if (categoryFilter) {
                    let rowCategory = null;
                    if (row.subCategory === "1.Res") rowCategory = "1.RES";
                    else if (row.subCategory === "2.Com") rowCategory = "2.COMM";
                    else if (row.subCategory === "3.Ind") rowCategory = "3.IND";
                    else if (row.subCategory === "4.Ag") rowCategory = "4.AG";
                    else if (row.subCategory === "6.PWW") rowCategory = "6.PWW";
                    else if (row.subCategory === "7.Public S") rowCategory = "7.PUBLIC-SERVICE";
                    else if (row.subCategory === "8.Other") rowCategory = "8.OTHER";
                    
                    if (rowCategory !== categoryFilter) {
                        includeRow = false;
                    }
                }

                // Apply phase filter
                if (phaseFilter && row.phase !== phaseFilter) {
                    includeRow = false;
                }

                // Apply report age filter
                if (reportAgeFilter && row.reportAge !== reportAgeFilter) {
                    includeRow = false;
                }

                // If row passes all filters, add to filtered data
                if (includeRow) {
                    const section = row.section;
                    const sectionObj = filteredData[section];
                    
                    // Update data with random distribution for demo
                    // Update A1.Stage
                    if (Math.random() > 0.3) sectionObj["A1.Stage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["A1.Stage"].approved += 1;
                    
                    // Update Tech Feasibility Stage
                    if (Math.random() > 0.2) sectionObj["TechFeasibility"].saved += 1;
                    if (Math.random() > 0.4) sectionObj["TechFeasibility"].submitted += 1;
                    if (Math.random() > 0.6) sectionObj["TechFeasibility"].approved += 1;
                    
                    // Update Estimate Stage
                    if (Math.random() > 0.1) sectionObj["EstimateStage"].saved += 1;
                    if (Math.random() > 0.3) sectionObj["EstimateStage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["EstimateStage"].verified += 1;
                    if (Math.random() > 0.7) sectionObj["EstimateStage"].rejected += 1;
                    if (Math.random() > 0.9) sectionObj["EstimateStage"].approved += 1;
                    
                    // Update Receipt Stage
                    if (Math.random() > 0.3) sectionObj["ReceiptStage"].submitted += 1;
                    if (Math.random() > 0.5) sectionObj["ReceiptStage"].approved += 1;
                    
                    // Update total
                    sectionObj.total += 1;
                }
            });

            updateTableWithData(filteredData);
            showNotification(`Filter applied. Data filtered based on criteria.`);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('infra-status-filter').value = '';
            document.getElementById('category-filter').value = '';
            document.getElementById('phase-filter').value = '';
            document.getElementById('report-age-filter').value = '';

            if (processedData) {
                updateTableWithData(processedData);
                showNotification('Filters cleared. Showing all data.');
            }
        }

        // Update table with data
        function updateTableWithData(sectionData) {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            let grandTotals = {
                a1Submitted: 0,
                a1Approved: 0,
                techSaved: 0,
                techSubmitted: 0,
                techApproved: 0,
                estSaved: 0,
                estSubmitted: 0,
                estVerified: 0,
                estRejected: 0,
                estApproved: 0,
                recSubmitted: 0,
                recApproved: 0,
                total: 0
            };

            // Add sections with data
            defaultSections.forEach(section => {
                if (!sectionData[section]) return;

                const row = document.createElement('tr');
                const sectionObj = sectionData[section];
                
                // Section name
                const sectionCell = document.createElement('td');
                sectionCell.textContent = section;
                row.appendChild(sectionCell);

                // A1. Stage - Submitted
                const a1SubmittedCell = document.createElement('td');
                a1SubmittedCell.textContent = sectionObj["A1.Stage"].submitted;
                row.appendChild(a1SubmittedCell);
                grandTotals.a1Submitted += sectionObj["A1.Stage"].submitted;

                // A1. Stage - Approved
                const a1ApprovedCell = document.createElement('td');
                a1ApprovedCell.textContent = sectionObj["A1.Stage"].approved;
                row.appendChild(a1ApprovedCell);
                grandTotals.a1Approved += sectionObj["A1.Stage"].approved;

                // Tech Feasibility Stage - Saved
                const techSavedCell = document.createElement('td');
                techSavedCell.textContent = sectionObj["TechFeasibility"].saved;
                row.appendChild(techSavedCell);
                grandTotals.techSaved += sectionObj["TechFeasibility"].saved;

                // Tech Feasibility Stage - Submitted
                const techSubmittedCell = document.createElement('td');
                techSubmittedCell.textContent = sectionObj["TechFeasibility"].submitted;
                row.appendChild(techSubmittedCell);
                grandTotals.techSubmitted += sectionObj["TechFeasibility"].submitted;

                // Tech Feasibility Stage - Approved
                const techApprovedCell = document.createElement('td');
                techApprovedCell.textContent = sectionObj["TechFeasibility"].approved;
                row.appendChild(techApprovedCell);
                grandTotals.techApproved += sectionObj["TechFeasibility"].approved;

                // Estimate Stage - Saved
                const estSavedCell = document.createElement('td');
                estSavedCell.textContent = sectionObj["EstimateStage"].saved;
                row.appendChild(estSavedCell);
                grandTotals.estSaved += sectionObj["EstimateStage"].saved;

                // Estimate Stage - Submitted
                const estSubmittedCell = document.createElement('td');
                estSubmittedCell.textContent = sectionObj["EstimateStage"].submitted;
                row.appendChild(estSubmittedCell);
                grandTotals.estSubmitted += sectionObj["EstimateStage"].submitted;

                // Estimate Stage - Verified
                const estVerifiedCell = document.createElement('td');
                estVerifiedCell.textContent = sectionObj["EstimateStage"].verified;
                row.appendChild(estVerifiedCell);
                grandTotals.estVerified += sectionObj["EstimateStage"].verified;

                // Estimate Stage - Rejected
                const estRejectedCell = document.createElement('td');
                estRejectedCell.textContent = sectionObj["EstimateStage"].rejected;
                row.appendChild(estRejectedCell);
                grandTotals.estRejected += sectionObj["EstimateStage"].rejected;

                // Estimate Stage - Approved
                const estApprovedCell = document.createElement('td');
                estApprovedCell.textContent = sectionObj["EstimateStage"].approved;
                row.appendChild(estApprovedCell);
                grandTotals.estApproved += sectionObj["EstimateStage"].approved;

                // Receipt Stage - Submitted
                const recSubmittedCell = document.createElement('td');
                recSubmittedCell.textContent = sectionObj["ReceiptStage"].submitted;
                row.appendChild(recSubmittedCell);
                grandTotals.recSubmitted += sectionObj["ReceiptStage"].submitted;

                // Receipt Stage - Approved
                const recApprovedCell = document.createElement('td');
                recApprovedCell.textContent = sectionObj["ReceiptStage"].approved;
                row.appendChild(recApprovedCell);
                grandTotals.recApproved += sectionObj["ReceiptStage"].approved;

                // TOTAL - Single column
                const totalCell = document.createElement('td');
                totalCell.textContent = sectionObj.total;
                row.appendChild(totalCell);
                grandTotals.total += sectionObj.total;

                tableBody.appendChild(row);
            });

            // Add TOTAL row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'TOTAL';
            totalRow.appendChild(totalLabelCell);

            // A1. Stage - Submitted total
            const a1SubmittedTotal = document.createElement('td');
            a1SubmittedTotal.textContent = grandTotals.a1Submitted;
            totalRow.appendChild(a1SubmittedTotal);

            // A1. Stage - Approved total
            const a1ApprovedTotal = document.createElement('td');
            a1ApprovedTotal.textContent = grandTotals.a1Approved;
            totalRow.appendChild(a1ApprovedTotal);

            // Tech Feasibility Stage - Saved total
            const techSavedTotal = document.createElement('td');
            techSavedTotal.textContent = grandTotals.techSaved;
            totalRow.appendChild(techSavedTotal);

            // Tech Feasibility Stage - Submitted total
            const techSubmittedTotal = document.createElement('td');
            techSubmittedTotal.textContent = grandTotals.techSubmitted;
            totalRow.appendChild(techSubmittedTotal);

            // Tech Feasibility Stage - Approved total
            const techApprovedTotal = document.createElement('td');
            techApprovedTotal.textContent = grandTotals.techApproved;
            totalRow.appendChild(techApprovedTotal);

            // Estimate Stage - Saved total
            const estSavedTotal = document.createElement('td');
            estSavedTotal.textContent = grandTotals.estSaved;
            totalRow.appendChild(estSavedTotal);

            // Estimate Stage - Submitted total
            const estSubmittedTotal = document.createElement('td');
            estSubmittedTotal.textContent = grandTotals.estSubmitted;
            totalRow.appendChild(estSubmittedTotal);

            // Estimate Stage - Verified total
            const estVerifiedTotal = document.createElement('td');
            estVerifiedTotal.textContent = grandTotals.estVerified;
            totalRow.appendChild(estVerifiedTotal);

            // Estimate Stage - Rejected total
            const estRejectedTotal = document.createElement('td');
            estRejectedTotal.textContent = grandTotals.estRejected;
            totalRow.appendChild(estRejectedTotal);

            // Estimate Stage - Approved total
            const estApprovedTotal = document.createElement('td');
            estApprovedTotal.textContent = grandTotals.estApproved;
            totalRow.appendChild(estApprovedTotal);

            // Receipt Stage - Submitted total
            const recSubmittedTotal = document.createElement('td');
            recSubmittedTotal.textContent = grandTotals.recSubmitted;
            totalRow.appendChild(recSubmittedTotal);

            // Receipt Stage - Approved total
            const recApprovedTotal = document.createElement('td');
            recApprovedTotal.textContent = grandTotals.recApproved;
            totalRow.appendChild(recApprovedTotal);

            // TOTAL - Single column
            const totalTotal = document.createElement('td');
            totalTotal.textContent = grandTotals.total;
            totalRow.appendChild(totalTotal);

            tableBody.appendChild(totalRow);
            updateStatusBar();
        }

        // Download abstract as Excel file
        function downloadAbstract() {
            if (!processedData) {
                showNotification('No data available to download', true);
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare data for the table
                const tableData = [];
                
                // Add headers
                tableData.push([
                    'Section',
                    'A1. Stage Submitted', 'A1. Stage Approved',
                    'Tech Feasibility Saved', 'Tech Feasibility Submitted', 'Tech Feasibility Approved',
                    'Estimate Saved', 'Estimate Submitted', 'Estimate Verified', 'Estimate Rejected', 'Estimate Approved',
                    'Receipt Submitted', 'Receipt Approved',
                    'Total'
                ]);

                // Add data for each section
                defaultSections.forEach(section => {
                    if (!processedData[section]) return;
                    
                    const sectionObj = processedData[section];
                    const row = [
                        section,
                        sectionObj["A1.Stage"].submitted,
                        sectionObj["A1.Stage"].approved,
                        sectionObj["TechFeasibility"].saved,
                        sectionObj["TechFeasibility"].submitted,
                        sectionObj["TechFeasibility"].approved,
                        sectionObj["EstimateStage"].saved,
                        sectionObj["EstimateStage"].submitted,
                        sectionObj["EstimateStage"].verified,
                        sectionObj["EstimateStage"].rejected,
                        sectionObj["EstimateStage"].approved,
                        sectionObj["ReceiptStage"].submitted,
                        sectionObj["ReceiptStage"].approved,
                        sectionObj.total
                    ];
                    tableData.push(row);
                });

                // Calculate totals
                const totals = {
                    a1Submitted: 0,
                    a1Approved: 0,
                    techSaved: 0,
                    techSubmitted: 0,
                    techApproved: 0,
                    estSaved: 0,
                    estSubmitted: 0,
                    estVerified: 0,
                    estRejected: 0,
                    estApproved: 0,
                    recSubmitted: 0,
                    recApproved: 0,
                    total: 0
                };

                defaultSections.forEach(section => {
                    if (!processedData[section]) return;
                    const sectionObj = processedData[section];
                    totals.a1Submitted += sectionObj["A1.Stage"].submitted;
                    totals.a1Approved += sectionObj["A1.Stage"].approved;
                    totals.techSaved += sectionObj["TechFeasibility"].saved;
                    totals.techSubmitted += sectionObj["TechFeasibility"].submitted;
                    totals.techApproved += sectionObj["TechFeasibility"].approved;
                    totals.estSaved += sectionObj["EstimateStage"].saved;
                    totals.estSubmitted += sectionObj["EstimateStage"].submitted;
                    totals.estVerified += sectionObj["EstimateStage"].verified;
                    totals.estRejected += sectionObj["EstimateStage"].rejected;
                    totals.estApproved += sectionObj["EstimateStage"].approved;
                    totals.recSubmitted += sectionObj["ReceiptStage"].submitted;
                    totals.recApproved += sectionObj["ReceiptStage"].approved;
                    totals.total += sectionObj.total;
                });

                // Add TOTAL row
                tableData.push([
                    'TOTAL',
                    totals.a1Submitted,
                    totals.a1Approved,
                    totals.techSaved,
                    totals.techSubmitted,
                    totals.techApproved,
                    totals.estSaved,
                    totals.estSubmitted,
                    totals.estVerified,
                    totals.estRejected,
                    totals.estApproved,
                    totals.recSubmitted,
                    totals.recApproved,
                    totals.total
                ]);

                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(tableData);
                XLSX.utils.book_append_sheet(wb, ws, 'Stagewise Analysis');

                // Generate Excel file and trigger download
                const fileName = `stagewise_paid_pending_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('Abstract downloaded successfully!');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Error downloading abstract: ' + error.message, true);
            }
        }

        // Generate list
        function generateList() {
            if (!processedData) {
                showNotification('No data available to generate list', true);
                return;
            }

            try {
                // Create workbook
                const wb = XLSX.utils.book_new();

                // Prepare detailed list data
                const listData = [];
                
                // Add headers for detailed list
                listData.push([
                    'Consumer No',
                    'Section',
                    'Sub Category',
                    'Closing Balance',
                    'Age in Days',
                    'Infra Status',
                    'Phase',
                    'Report Age'
                ]);

                // Add all raw data rows
                rawData.forEach(row => {
                    const listRow = [
                        row.consumerNo,
                        row.section,
                        row.subCategory,
                        row.closingBalance,
                        row.ageInDays,
                        row.infraStatus,
                        row.phase,
                        row.reportAge
                    ];
                    listData.push(listRow);
                });

                // Create worksheet for detailed list
                const ws = XLSX.utils.aoa_to_sheet(listData);
                XLSX.utils.book_append_sheet(wb, ws, 'Detailed List');

                // Generate Excel file and trigger download
                const fileName = `detailed_list_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showNotification('List generated and downloaded successfully!');
            } catch (error) {
                console.error('List generation error:', error);
                showNotification('Error generating list: ' + error.message, true);
            }
        }

        // Generate abstract from data
        async function generateAbstract() {
            try {
                // Get selected date and file type
                const datePart = getSelectedDate();
                const fileType = getSelectedFileType();

                if (!datePart) {
                    showNotification('Please select a valid date', true);
                    return;
                }

                const fileName = `${datePart}.${fileType}`;

                setLoadingState(true);
                updateProgress(0, 'Fetching data files from GitHub...');

                // Load DBS lookup data first
                updateProgress(10, 'Loading DBS lookup data...');
                await loadDBSLookupData();

                updateProgress(30, 'Fetching main data file...');

                // Try different date formats and file types
                const possibleFileNames = [
                    fileName,
                    fileName.toLowerCase(),
                    fileName.replace(/-/g, '_'),
                    fileName.replace('.xlsx', '.csv'),
                    fileName.replace('.xls', '.csv'),
                    fileName.replace('.csv', '.xlsx')
                ];

                let data = null;
                let usedFileName = '';

                for (const name of possibleFileNames) {
                    try {
                        data = await fetchFileFromGitHub(name);
                        usedFileName = name;
                        console.log(`Successfully loaded ${name}`);
                        break;
                    } catch (error) {
                        console.warn(`Failed to load ${name}:`, error);
                        continue;
                    }
                }

                if (!data) {
                    throw new Error(`Could not find data file. Tried: ${possibleFileNames.join(', ')}`);
                }

                updateProgress(60, 'Processing data...');

                let jsonData;
                if (fileType === 'csv') {
                    const csvString = new TextDecoder().decode(data);
                    jsonData = XLSX.utils.sheet_to_json(
                        XLSX.utils.aoa_to_sheet(
                            csvString.split('\n').map(row => row.split(','))
                        ),
                        { header: 1 }
                    );
                } else {
                    const workbook = XLSX.read(data, { type: 'array' });
                    if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                        throw new Error('Excel file contains no sheets');
                    }
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                }

                if (jsonData.length <= 1) {
                    showNotification('No data found in the file', true);
                    updateImportStatus('No data found');
                    setLoadingState(false);
                    return;
                }

                updateProgress(80, 'Generating abstract...');

                // Process the data
                processedData = processExcelData(jsonData);

                setLoadingState(false);
                updateProgress(100, 'Abstract generated successfully');

                // Update table with processed data
                updateTableWithData(processedData);

                showNotification(`Successfully generated abstract from ${usedFileName}!`);
                updateImportStatus(`Abstract generated from ${usedFileName}`);

                updateStatusBar();

            } catch (error) {
                console.error('Error generating abstract:', error);
                showNotification('Error generating abstract: ' + error.message, true);
                updateImportStatus('Generation failed');
                setLoadingState(false);
            }
        }

        // Event listeners
        document.getElementById('generate-abstract').addEventListener('click', generateAbstract);
        document.getElementById('download-abstract').addEventListener('click', downloadAbstract);
        document.getElementById('generate-list').addEventListener('click', generateList);

        document.getElementById('apply-filter').addEventListener('click', applyFilters);
        document.getElementById('clear-filter').addEventListener('click', clearFilters);

        // Back to Main button
        document.getElementById('back-to-dashboard').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateDropdowns();

            // Debug help
            console.log('Stagewise Paid Pending Analysis initialized');
            console.log('Default sections:', defaultSections);
            console.log('GitHub Repo URL:', GITHUB_REPO_URL);
        });
    </script>
</body>
</html>